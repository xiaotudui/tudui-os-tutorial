## 1. 分段

### 内存的管理使用

在进程那一章，我们说了程序的运行，其实质是CPU从内存中取指执行。

所以想想内存应该有哪些作用？

* 存储运行指令
* 为进程分配内存空间
* 提供地址，CPU需要相关地址处的信息的时候，可以在内存中找到

### 分段

我们可以写一段简单的c代码（code/memory/segment_1.c)：

```c
#include <stdio.h>
int main()
{
   int a = 1;
   printf("Hello, World!");
   return 0;
}
```

然后将其转为汇编，运行：

```c
gcc -S segment_1.c
```

之后会生成一个.s 文件（code/memory/segment_1.s)，不用细看内容。

我们发现，这个汇编代码中，有 .string main .text，反正分为不同的块。

```c
	.file	"segment_1.c"
	.text
	.section	.rodata
.LC0:
	.string	"Hello, World!"
	.text
	.globl	main
	.type	main, @function
main:
.LFB0:
	.cfi_startproc
	pushq	%rbp
	.cfi_def_cfa_offset 16
	.cfi_offset 6, -16
	movq	%rsp, %rbp
	.cfi_def_cfa_register 6
	subq	$16, %rsp
	movl	$1, -4(%rbp)
	leaq	.LC0(%rip), %rdi
	movl	$0, %eax
	call	printf@PLT
	movl	$0, %eax
	leave
	.cfi_def_cfa 7, 8
	ret
	.cfi_endproc
.LFE0:
	.size	main, .-main
	.ident	"GCC: (Ubuntu 7.5.0-3ubuntu1~18.04) 7.5.0"
	.section	.note.GNU-stack,"",@progbits

```

进程在内存中，主要是按照这种形式进行存储的。

![](https://pic.imgdb.cn/item/5eaa9256c2a9a83be5300fa1.png)

### 为什么要分段呢？

我们看上面那张图片，分为不同段，每个段的读写属性是不同的。比如正文段存储代码，就像我们上面的.s文件中的main部分。它在内存中是始终不变的，我们CPU就是从main中去取指执行。所以，它是只读的。





### 参考

《深入理解计算机系统》

* 7.9 加载可执行目标文件